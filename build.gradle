plugins {
    id 'org.jetbrains.kotlin.jvm' version '1.4.30'
    id 'org.jetbrains.kotlin.plugin.spring' version '1.4.30'
    id 'org.springframework.boot' version '2.4.3'
    id 'io.spring.dependency-management' version '1.0.11.RELEASE'
}

configurations {
    dd_agent
}

sourceCompatibility = JavaVersion.VERSION_1_8
targetCompatibility = JavaVersion.VERSION_1_8

repositories {
    mavenCentral()
}

dependencies {

    implementation(
            "org.springframework.boot:spring-boot-starter-webflux"
    )

    dd_agent 'com.datadoghq:dd-java-agent:0.74.0'

}

task copyDdAgent(type: Copy) {
    from configurations.dd_agent
    into "$buildDir/dd-agent"
}

bootRun {
    main = 'com.AppKt'
    jvmArgs += ["-javaagent:$buildDir/dd-agent/dd-java-agent-0.74.0.jar", "-Ddatadog.slf4j.simpleLogger.logFile=$buildDir/dd-agent/log.txt", '-Ddd.trace.debug=true']
}

bootRun.dependsOn copyDdAgent

tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
    kotlinOptions.jvmTarget = "1.8"
}

wrapper {
    distributionType = Wrapper.DistributionType.ALL
}